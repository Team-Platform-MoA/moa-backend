"""
리포트 생성 프롬프트
"""
from app.prompts.base import BasePrompt
from string import Template


class EmotionReportPrompt(BasePrompt):
    """감정 리포트 생성 프롬프트"""
    
    def generate(self, user_answers: str) -> str:
        """
        감정 리포트 생성 프롬프트를 생성합니다.
        
        Args:
            user_answers: Q&A 형식의 사용자 답변 텍스트
                예: "Q1: 어머니의 상태 중에서 오늘 가장 신경 쓰인 부분이 있으셨나요?\n
                     A1: 오늘 아침에 어머니가 제 이름을 불러주셨어요. 오랜만에 들어서 눈물이 났습니다.\n
                     Q2: 오늘 돌봄 과정에서 '아, 이건 정말 나 혼자서는 안 되겠다'라고 느낀 순간이 있으셨나요?\n
                     A2: 어머니가 갑자기 화를 내시며 저를 알아보지 못하실 때였어요. 정말 무력감을 느꼈습니다.\n
                     Q3: 오늘 본인을 위해 챙긴 것이 있다면 어떤 것이었나요? 혹시 챙기지 못했다면 그 이유는 뭐였을까요?\n
                     A3: 챙기지 못했어요. 하루 종일 어머니 돌보느라 정신이 없었거든요."
            
        Returns:
            str: 완성된 프롬프트
        """

        PROMPT_TPL = Template(r"""
        당신은 치매 환자를 돌보는 가족(부양자)의 감정을 이해하고 위로하는 전문 심리상담가입니다. 
        입력된 내용은 치매 부양자가 오늘 하루 겪은 일과 감정을 표현한 것입니다.

        # 입력
        $user_answers

        # 작성 지침
        1. 부양자의 감정을 세밀하게 판별하세요.
        2. 깊이 공감하며 부양자의 노고를 인정하고, 혼자가 아니라는 안도감을 주세요.
        3. 지나친 희망 고문은 피하고, 현실적이고 따뜻한 언어를 사용하세요.
        4. 정서적 소진을 완화하는 방향으로 답변하세요.
        5. 구체적이고 실천 가능한 자기돌봄 action plan을 제시하세요.
        6. JSON만 반환하고 다른 설명은 포함하지 마세요.

        # 출력 형식
        아래 JSON 구조를 정확히 지켜서 반환하세요. (모든 필드 반드시 포함)

        {
          "emotion_score": int,
          "daily_summary": "부양자의 하루를 인정하는 한국어 한 문장 (18글자 이하, 공백 포함)",
          "emotion_analysis": {
            "stress": int,
            "resilience": int,
            "stability": int
          },
          "actions": "오늘 하루 마무리에 시도할 수 있는 자기돌봄 action plan 1~2개 (200~400자 줄글)",
          "letter": "부양자의 감정을 그대로 반영해 4~5문장으로 작성된 개인화 편지"
        }

        # daily_summary 작성 규칙
        - 반드시 한국어 18글자 이하 (공백 포함)
        - 따뜻한 인정과 위로를 담을 것
        - 예시:
          - "오늘도 정말 수고하셨어요" (12글자)
          - "당신의 사랑이 빛났던 하루" (13글자)
          - "묵묵히 견딘 당신, 대단해요" (14글자)
          - "오늘도 최선을 다한 당신" (12글자)

        # 점수 계산 기준
        - emotion_score: 전반적 정서 상태 (소진·희망·자기돌봄 의지 종합)
        - stress (스트레스)
          * 70-100: 한계, 탈진, 분노, 죄책감
          * 40-70: 일상적 피로, 걱정
          * 0-40: 안정, 수용
        - resilience (회복 탄력성)
          * 70-100: 자기격려, 의미 찾기, 적극적 대처
          * 40-70: 버티고 있음, 일부 긍정성
          * 0-40: 소진, 포기감
        - stability (정서 안정)
          * 70-100: 감정 조절, 수용
          * 40-70: 기복 있으나 유지
          * 0-40: 감정 기복 심함, 통제 어려움
        """)

        prompt = PROMPT_TPL.substitute(user_answers=user_answers)
        return prompt
    
    def get_expected_format(self) -> str:
        """기대하는 응답 형식을 반환합니다."""
        return "json" 